<div class="crm wrapper">
  <div class="crm-content">
    <header class="header1">
      <div class="id-block">
        <div class="avatar">{{ getInitials((customer?.name || customer?.firstName || '') + ' ' + (customer?.lastName || '')) }}</div>
        <div class="id-meta">
          <div class="title-row">
            <h3 class="title">{{ customer?.name || customer?.firstName }} {{ customer?.lastName }}</h3>
            <span class="chip" [ngClass]="leadChipClass(leadScore)">
              <i class="bi bi-stars me-1"></i> Lead: {{ leadScore }}
            </span>
          </div>

          <div class="sub">
            <span><i class="bi bi-envelope me-1"></i>{{ customer?.email || '‚Äî' }}</span>
            <span class="dot">‚Ä¢</span>
            <span><i class="bi bi-telephone me-1"></i>{{ customer?.mobile || customer?.phone || '‚Äî' }}</span>
          </div>

          <div class="pill-row">
            @if ((clv || 0) > 20000) { <span class="pill vip">üíé VIP</span> }
            @if (orders.length >= 4) { <span class="pill frequent">üîÅ Frequent</span> }
            @if (isDormant()) { <span class="pill dormant">üõë Dormant</span> }
            <span class="pill" [ngClass]="{'vip': customer?.tier === 'Gold', 'frequent': customer?.tier === 'Silver'}">
              {{ customer?.tier || 'Standard' }} Member
            </span>
          </div>

          <div class="assignee-row mt-3">
            <span class="label text-muted">Owner:</span>
            @if (assignedToUserId) {
              <span class="assignee-pill ms-2">
                <i class="bi bi-person-check me-1"></i>{{ assignedToName || 'Unknown' }}
              </span>
              <button class="btn tiny ghost ms-2" (click)="openAssignModal()">Change</button>
            } @else {
              <button class="btn tiny primary ms-2" (click)="openAssignModal()">+ Assign Owner</button>
            }
          </div>
        </div>
      </div>

      <div class="metrics">
        <div class="metric"><span>Lifetime Spend</span><strong>‚Çπ{{ clv | number }}</strong></div>
        <div class="metric"><span>Total Points</span><strong>{{ customer?.loyaltyPoints || 0 }}</strong></div>
        <div class="metric"><span>Orders</span><strong>{{ orders.length }}</strong></div>
        <div class="metric"><span>Last Purchase</span><strong>{{ lastPurchaseDate || 'N/A' }}</strong></div>
        <div class="metric">
          <span>Est. Close</span>
          <strong>{{ estCloseDays }}d</strong>
          <small>{{ estCloseText }}</small>
        </div>
      </div>
    </header>

    <main class="grid">
      <section class="col">
        <div class="card">
          <div class="card-head">
            <h5>Pipeline Status</h5>
            <div class="row-actions">
              <button class="btn ghost" (click)="addNoteFromQuick()">+ Note</button>
            </div>
          </div>
          <div class="pipeline mt-3">
            <div class="stage" [class.active]="pipelineStage==='new'">New</div>
            <div class="stage" [class.active]="pipelineStage==='contacted'">Contacted</div>
            <div class="stage" [class.active]="pipelineStage==='qualified'">Qualified</div>
            <div class="stage" [class.active]="pipelineStage==='won'">Won</div>
            <div class="stage" [class.active]="pipelineStage==='lost'">Lost</div>
          </div>
          <div class="inline-controls mt-4">
            <label class="text-muted small fw-bold mb-2 d-block">Update Stage</label>
            <select [(ngModel)]="pipelineStage" (change)="savePipelineStage()">
              <option value="new">New</option>
              <option value="contacted">Contacted</option>
              <option value="qualified">Qualified</option>
              <option value="won">Won</option>
              <option value="lost">Lost</option>
            </select>
          </div>
        </div>

        <div class="card">
          <div class="card-head">
            <h5><i class="bi bi-wallet2 me-2"></i>Points Wallet History</h5>
          </div>
          <div class="table-responsive">
            <table class="table wallet-table m-0">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Reason</th>
                  <th class="text-end">Points</th>
                </tr>
              </thead>
              <tbody>
                @for (tx of walletTransactions; track tx.id) {
                  <tr>
                    <td>{{ formatDate(tx.createdAt) }}</td>
                    <td>
                      <span [class]="tx.type === 'EARN' ? 'text-success' : 'text-danger'" style="font-weight: 600;">
                        {{ tx.type }}
                      </span>
                    </td>
                    <td style="font-size: 13px; color: var(--muted);">{{ tx.reason || 'Order' }}</td>
                    <td class="text-end" [class.text-success]="tx.type === 'EARN'" [class.text-danger]="tx.type === 'REDEEM'" style="font-weight: 700;">
                      {{ tx.type === 'EARN' ? '+' : '-' }}{{ tx.points }}
                    </td>
                  </tr>
                }
                @if (walletTransactions.length === 0) {
                  <tr>
                    <td colspan="4" class="text-center py-4 text-muted">No point history available</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-head">
            <h5>Reminders</h5>
            <div class="toggle d-flex align-items-center gap-2">
              <label class="small text-muted">List</label>
              <div class="form-check form-switch m-0">
                <input type="checkbox" [(ngModel)]="showCalendarView" class="form-check-input" />
              </div>
              <label class="small text-muted">Calendar</label>
            </div>
          </div>
          @if (showCalendarView) {
            <div id="calendar" class="calendar mt-3"></div>
          } @else {
            <div class="list mt-3">
              <button class="btn ghost w-100 mb-3" data-bs-toggle="modal" data-bs-target="#reminderModal">+ Add New Reminder</button>
              @for (reminder of reminders; track reminder.id) {
                <div class="item">
                  <div class="left">
                    <span class="avatar mini">üìÖ</span>
                    <div class="txt">
                      <div class="line">{{ reminder.text }}</div>
                      <small class="muted">Type: {{ reminder.type || 'general' }} ‚Ä¢ Due: {{ formatDate(reminder.dueDate) }}</small>
                    </div>
                  </div>
                  <div class="right d-flex gap-2">
                    <button class="btn tiny" (click)="snoozeReminder(reminder.id, 7)">‚è≥ 7d</button>
                    <button class="btn tiny ghost" (click)="openReminder(reminder)">Edit</button>
                  </div>
                </div>
              }
              @if (reminders.length === 0) {
                <p class="muted small text-center mt-3">No reminders yet.</p>
              }
            </div>
          }
        </div>
      </section>

      <section class="col">
        <div class="grid two">
          <div class="card">
            <div class="card-head"><h5>Lead Score</h5></div>
            <div class="gauge">
              <canvas baseChart [type]="'doughnut'" [data]="leadGaugeData" [options]="leadGaugeOptions" height="220"></canvas>
              <div class="gauge-center">
                <div class="big">{{ leadScore }}</div>
                <div class="muted tiny text-uppercase tracking-wide">Score</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-head"><h5>Payment Breakdown</h5></div>
            <div class="mini-metrics">
              <div class="metric flex-fill text-center p-3"><span>Received</span><strong>‚Çπ{{ paymentReceived | number }}</strong></div>
              <div class="metric flex-fill text-center p-3"><span>Pending</span><strong>‚Çπ{{ paymentPending | number }}</strong></div>
            </div>
            <div class="chart-wrap mt-4">
              <canvas baseChart [type]="'doughnut'" [data]="paymentDoughnutData" [options]="doughnutOptions" height="200"></canvas>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-head">
            <h5>Revenue Over Time</h5>
            <button class="btn tiny ghost" (click)="toggleChartType()">
              Switch to {{ chartType === 'line' ? 'Bar' : 'Line' }}
            </button>
          </div>
          @if (chartLoading) {
            <div class="text-center p-4"><div class="spinner-border text-primary"></div></div>
          } @else {
            <div class="chart-wrap mt-3">
              <canvas baseChart [data]="revenueChartData" [options]="revenueChartOptions" [type]="chartType" height="260"></canvas>
            </div>
          }
        </div>

        <div class="card">
          <div class="card-head"><h5>Forecast Probability</h5></div>
          <div class="chart-wrap mt-3">
            <canvas baseChart [type]="'bar'" [data]="forecastBarData" [options]="forecastBarOptions" height="220"></canvas>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<div class="modal fade" id="noteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Note</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <textarea [(ngModel)]="newNote" class="form-control" rows="4" placeholder="Type your note..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn ghost" data-bs-dismiss="modal">Cancel</button>
        <button class="btn primary" (click)="addNote()" data-bs-dismiss="modal">Save Note</button>
      </div>
    </div>
  </div>
</div>