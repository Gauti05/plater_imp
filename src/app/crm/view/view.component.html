<div class="crm wrapper">
  <div class="crm-content">
    <header class="header1">
      <div class="id-block">
        <div class="avatar">{{ getInitials((customer?.firstName || '') + ' ' + (customer?.lastName || '')) }}</div>
        <div class="id-meta">
          <div class="title-row">
            <h3 class="title">{{ customer?.firstName }} {{ customer?.lastName }}</h3>
            <span class="chip" [ngClass]="leadChipClass(leadScore)">
              <i class="bi bi-stars me-1"></i> Lead: {{ leadScore }}
            </span>
          </div>

          <div class="sub">
            <span><i class="bi bi-envelope me-1"></i>{{ customer?.email || '‚Äî' }}</span>
            <span class="dot">‚Ä¢</span>
            <span><i class="bi bi-telephone me-1"></i>{{ customer?.phone || '‚Äî' }}</span>
            <span class="dot">‚Ä¢</span>
            <span><i class="bi bi-geo-alt me-1"></i>{{ customer?.address || '‚Äî' }}, {{ customer?.city || '‚Äî' }} ({{ customer?.pin || '‚Äî' }})</span>
          </div>

          <div class="pill-row">
            @if ((clv || 0) > 20000) { <span class="pill vip">üíé VIP</span> }
            @if (orders.length >= 4) { <span class="pill frequent">üîÅ Frequent</span> }
            @if (isDormant()) { <span class="pill dormant">üõë Dormant</span> }
          </div>

          <div class="assignee-row">
            <span class="label">Owner:</span>
            @if (assignedToUserId) {
              <span class="assignee-pill">
                <i class="bi bi-person-check me-1"></i>{{ assignedToName || 'Unknown' }}
              </span>
              <button class="btn tiny ghost ms-2" (click)="openAssignModal()">Change</button>
              <button class="btn tiny danger ghost ms-1" (click)="unassignLead()">Unassign</button>
            } @else {
              <button class="btn tiny primary" (click)="openAssignModal()">+ Assign Owner</button>
            }
            <small class="muted ms-2" *ngIf="assignedAt">since {{ assignedAt | date:'dd MMM yyyy, h:mm a' }}</small>
          </div>
        </div>
      </div>

      <div class="metrics">
        <div class="metric"><span>CLV</span><strong>‚Çπ{{ clv | number }}</strong></div>
        <div class="metric"><span>AOV</span><strong>‚Çπ{{ aov | number }}</strong></div>
        <div class="metric"><span>Orders</span><strong>{{ orders.length }}</strong></div>
        <div class="metric"><span>Last Purchase</span><strong>{{ lastPurchaseDate || 'N/A' }}</strong></div>
        <div class="metric">
          <span>Est. Close</span>
          <strong>{{ estCloseDays }}d</strong>
          <small>{{ estCloseText }}</small>
        </div>
      </div>
    </header>

    <main class="grid">
      <section class="col">
        <div class="card">
          <div class="card-head">
            <h5>Pipeline</h5>
            <div class="row-actions">
              <button class="btn ghost" data-bs-toggle="modal" data-bs-target="#reminderModal">+ Reminder</button>
              <button style="margin-left: 5px !important;" class="btn ghost" (click)="addNoteFromQuick()">+ Note</button>
            </div>
          </div>

          <div class="pipeline">
            <div class="stage" [class.active]="pipelineStage==='new'">New</div>
            <div class="stage" [class.active]="pipelineStage==='contacted'">Contacted</div>
            <div class="stage" [class.active]="pipelineStage==='qualified'">Qualified</div>
            <div class="stage" [class.active]="pipelineStage==='won'">Won</div>
            <div class="stage" [class.active]="pipelineStage==='lost'">Lost</div>
          </div>

          <div class="inline-controls">
            <label>Stage</label>
            <select [(ngModel)]="pipelineStage" (change)="savePipelineStage()">
              <option value="new">New</option>
              <option value="contacted">Contacted</option>
              <option value="qualified">Qualified</option>
              <option value="won">Won</option>
              <option value="lost">Lost</option>
            </select>
          </div>
        </div>

        <div class="card">
          <div class="card-head">
            <h5>Reminders</h5>
            <div class="toggle">
              <label>List</label>
              <input type="checkbox" [(ngModel)]="showCalendarView" />
              <label>Calendar</label>
            </div>
          </div>

          @if (showCalendarView) {
            <div id="calendar" class="calendar"></div>
          } @else {
            <div class="list">
              <button class="btn ghost" data-bs-toggle="modal" data-bs-target="#reminderModal">+ Add</button>

              @for (reminder of reminders; track reminder.id) {
                <div class="item">
                  <div class="left">
                    <span class="avatar mini">üìÖ</span>
                    <div class="txt">
                      <div class="line">{{ reminder.text }}</div>
                      <small class="muted">Type: {{ reminder.type || 'general' }} ‚Ä¢ Due: {{ formatDate(reminder.dueDate) }}</small>
                    </div>
                  </div>
                  <div class="right">
                    <button class="btn tiny" (click)="snoozeReminder(reminder.id, 7)">‚è≥ 7d</button>
                    <button class="btn tiny ghost" (click)="openReminder(reminder)">Edit</button>
                  </div>
                </div>
              }

              @if (reminders.length === 0) {
                <p class="muted small">No reminders yet.</p>
              }
            </div>
          }
        </div>

        <div class="card">
          <div class="card-head">
            <h5>Notes</h5>
            <button class="btn ghost" data-bs-toggle="modal" data-bs-target="#noteModal">+ Add</button>
          </div>

          <ul class="timeline">
            @for (note of notes; track note.id) {
              <li class="tl-item">
                <span class="avatar mini">‚úçÔ∏è</span>
                <div class="bubble">
                  <div class="line">{{ note.text }}</div>
                  <small class="muted">{{ formatDate(note.createdAt) }} ‚Ä¢ <span class="tag light">{{ note.type || 'General' }}</span></small>
                </div>
              </li>
            }
          </ul>

          @if (notes.length === 0) {
            <p class="muted small">No notes yet.</p>
          }
        </div>

        <div class="card">
          <div class="card-head">
            <h5>Tags</h5> <button class="btn ghost" data-bs-toggle="modal" data-bs-target="#manualTagModal">+ Add Manual Tag</button>
          </div>
          
          @if (autoTags.length === 0) {
            <p class="muted small">No tags</p>
          } @else {
            <div class="tags">
              @for (tag of autoTags; track tag) { 
                <span class="tag">{{ tag }}</span> 
              }
            </div>
          }
        </div>
      </section>

      <section class="col">
        <div class="grid two">
          <div class="card">
            <div class="card-head"><h5>Lead Score</h5></div>
            <div class="gauge">
              <canvas
                baseChart
                [type]="'doughnut'"
                [data]="leadGaugeData"
                [options]="leadGaugeOptions"
                height="220">
              </canvas>
              <div class="gauge-center">
                <div class="big">{{ leadScore }}</div>
                <div class="muted tiny">out of 100</div>
              </div>
            </div>
            <p class="muted tiny mt-2">Stage, recency, engagement & value blended.</p>
          </div>

          <div class="card">
            <div class="card-head"><h5>Payment Breakdown</h5></div>
            <div class="mini-metrics">
              <div class="metric"><span>Received</span><strong>‚Çπ{{ paymentReceived | number }}</strong></div>
              <div class="metric"><span>Pending</span><strong>‚Çπ{{ paymentPending | number }}</strong></div>
            </div>
            <div class="chart-wrap">
              <canvas baseChart [type]="'doughnut'" [data]="paymentDoughnutData" [options]="doughnutOptions" height="220"></canvas>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-head">
            <h5>Revenue Over Time</h5>
            <button class="btn tiny" (click)="toggleChartType()">
              Switch to {{ chartType === 'line' ? 'Bar' : 'Line' }}
            </button>
          </div>
          @if (chartLoading) {
            <div class="center pad"><div class="spinner-border text-primary" role="status"></div></div>
          } @else {
            <div class="chart-wrap">
              <canvas baseChart [data]="revenueChartData" [options]="revenueChartOptions" [type]="chartType" height="260"></canvas>
            </div>
          }
        </div>

        <div class="card">
          <div class="card-head"><h5>Forecast Probability</h5></div>
          <div class="chart-wrap">
            <canvas
              baseChart
              [type]="'bar'"
              [data]="forecastBarData"
              [options]="forecastBarOptions"
              height="220">
            </canvas>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<div class="modal fade" id="noteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Note</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label class="form-label">Note</label>
        <textarea [(ngModel)]="newNote" class="form-control" rows="4" placeholder="Type your note..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-sm btn-primary" (click)="addNote()" data-bs-dismiss="modal" [disabled]="!newNote.trim().length">
          Save Note
        </button>
      </div>
    </div>
  </div>
</div>