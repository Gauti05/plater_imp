@if (!fullscreenMode()) {
  <div class="biz-layout"
       [class.sidebar-collapsed]="!sidebarOpen()"
       [class.sidebar-open]="sidebarOpen()">

    <div class="biz-sidebar-backdrop" (click)="toggleSidebar()"></div>

    <aside class="biz-sidebar" aria-label="Main navigation">
      <div class="biz-brand">
        <img
          class="biz-brand-logo"
          src="https://firebasestorage.googleapis.com/v0/b/bizzeazyr.firebasestorage.app/o/Screenshot_2025-09-12-17-38-09-79_6012fa4d4ddec268fc5c7112cbb265e7.jpg?alt=media&token=dd3da86d-0a7a-40dc-99cc-5d359f6142d4"
          alt="Bizzeazy logo"
        />
      </div>

      <nav class="biz-nav">
        @if (storeSlug()) {

          @if (userRole() === 'Admin' || userRole() === 'Storeadmin' || userRole() === 'Superadmin') {
            <a class="biz-nav-item"
               [routerLink]="['/', storeSlug(), 'dashboard']"
               routerLinkActive="active"
               [routerLinkActiveOptions]="{ exact: true }">
              <svg viewBox="0 0 24 24" class="icon"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
              <span>Dashboard</span>
            </a>
          }

          <a class="biz-nav-item" [routerLink]="['/', storeSlug(), 'orders']" routerLinkActive="active">
            <svg viewBox="0 0 24 24" class="icon"><path d="M21 7H7V3H3v18c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V7zM7 21H5V5h2v16zm2 0V9h10v12H9z"/></svg>
            <span>Orders</span>
          </a>

          @if (userRole() === 'Admin' || userRole() === 'Storeadmin' || userRole() === 'Superadmin') {
            <a class="biz-nav-item" [routerLink]="['/', storeSlug(), 'inventory']" routerLinkActive="active">
              <svg viewBox="0 0 24 24" class="icon"><path d="M20.54 5.23l-8.49-3.67c-.34-.15-.73-.15-1.07 0L2.49 5.23C2.18 5.36 2 5.67 2 6v12c0 .39.23.74.59.91l8.49 3.67c.34.15.73.15 1.07 0l8.49-3.67c.36-.17.59-.52.59-.91V6c0-.33-.18-.64-.49-.77zM12 4.15L18.74 7 12 9.85 5.26 7 12 4.15zM4 8.69l7 3.02v7.59l-7-3.02V8.69zm9 10.61v-7.59l7-3.02v7.59l-7 3.02z"/></svg>
              <span>Inventory</span>
            </a>
          }

          <a class="biz-nav-item" [routerLink]="['/', storeSlug(), 'pos']" routerLinkActive="active">
            <svg viewBox="0 0 24 24" class="icon"><path d="M19 7V4c0-1.1-.9-2-2-2H7c-1.1 0-2 .9-2 2v3H2v13c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7h-3zM7 4h10v3H7V4zm13 16H4V9h16v11zM6 11h12v2H6v-2zm0 4h12v2H6v-2z"/></svg>
            <span>POS</span>
          </a>

          @if (userRole() === 'Admin' || userRole() === 'Storeadmin' || userRole() === 'Superadmin') {
            <a class="biz-nav-item" [routerLink]="['/', storeSlug(), 'users']" routerLinkActive="active">
              <svg viewBox="0 0 24 24" class="icon"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
              <span>Users</span>
            </a>

            <a class="biz-nav-item" [routerLink]="['/', storeSlug(), 'reports']" routerLinkActive="active">
              <svg viewBox="0 0 24 24" class="icon"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0-8h14V7H7v2z"/></svg>
              <span>Reports</span>
            </a>

            <a class="biz-nav-item" [routerLink]="['/', storeSlug(), 'crm']" routerLinkActive="active">
              <svg viewBox="0 0 24 24" class="icon"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5s-3 1.34-3 3 1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
              <span>CRM</span>
            </a>

            <a class="biz-nav-item" [routerLink]="['/', storeSlug(), 'marketing']" routerLinkActive="active">
              <svg viewBox="0 0 24 24" class="icon"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
              <span>Marketing</span>
            </a>
          }

          <a class="biz-nav-item"
             [href]="'https://platterweb.bizzeazy.com/' + storeSlug()"
             target="_blank"
             rel="noopener noreferrer">
            <svg viewBox="0 0 24 24" class="icon"><path d="M19 19H5V5h7V3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
            <span>View Store</span>
          </a>

          @if (userRole() === 'Admin' || userRole() === 'Storeadmin' || userRole() === 'Superadmin') {
            <div class="biz-nav-group">
              <button class="biz-nav-item group-header" (click)="toggleSettingsOpen()">
                <svg viewBox="0 0 24 24" class="icon">
                  <path d="M19.14,12.94a1.43,1.43,0,0,0,0-1.88l2.09-1.63a.5.5,0,0,0,.11-.63l-2-3.46a.5.5,0,0,0-.61-.22l-2.46,1a5.38,5.38,0,0,0-1.6-.93L14,2.5a.5.5,0,0,0-.5-.5H10.5A.5.5,0,0,0,10,2.5L9.33,5.19a5.38,5.38,0,0,0-1.6.93l-2.46-1a.5.5,0,0,0-.61.22l-2,3.46a.5.5,0,0,0,.11.63L4.86,11.06a1.43,1.43,0,0,0,0,1.88L2.77,14.57a.5.5,0,0,0-.11.63l2,3.46a.5.5,0,0,0,.61.22l2.46-1a5.38,5.38,0,0,0,1.6.93L10,21.5a.5.5,0,0,0,.5.5h3A.5.5,0,0,0,14,21.5l.67-2.69a5.38,5.38,0,0,0,1.6-.93l2.46,1a.5.5,0,0,0,.61-.22l2-3.46a.5.5,0,0,0-.11-.63Zm-7.14,2.06A3,3,0,1,1,15,12,3,3,0,0,1,12,15Z"/>
                </svg>
                <span>Settings</span>
                <svg class="dropdown-icon" [class.open]="settingsOpen()" viewBox="0 0 24 24">
                  <path d="M7 10l5 5 5-5z"/>
                </svg>
              </button>

              @if (settingsOpen()) {
                <div class="biz-submenu">
                  <a class="biz-nav-item sub-item" [routerLink]="['/', storeSlug(), 'profile']" routerLinkActive="active">Profile</a>
                  <a class="biz-nav-item sub-item" [routerLink]="['/', storeSlug(), 'customise']" routerLinkActive="active">Customise</a>
                  
                  <a class="biz-nav-item sub-item" [routerLink]="['/', storeSlug(), 'table']" routerLinkActive="active">Table Management</a>
                  
                  <a class="biz-nav-item sub-item" [routerLink]="['/', storeSlug(), 'loyalty-rules']" routerLinkActive="active">Loyalty Rules</a>
                </div>
              }
            </div>
          }
          
          @if (userRole() === 'Admin' || userRole() === 'Superadmin') {
            <div style="margin: 16px 0; border-top: 1px solid #e2e8f0; opacity: 0.5;"></div>
            <a class="biz-nav-item" routerLink="/outlets">
              <svg viewBox="0 0 24 24" class="icon"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
              <span style="font-weight: 600; color: #2563EB;">Switch Outlet</span>
            </a>
          }

        } @else {
          <div class="biz-nav-item" style="opacity:0.5; cursor: not-allowed;">
            Loading store...
          </div>
        }
      </nav>

      <div class="biz-sidebar-footer">
        <p style="opacity: 0.4;">1.1.15</p>
      </div>
    </aside>

    <main class="biz-main">
      <header class="biz-topbar">
        <button class="biz-icon-btn" (click)="toggleSidebar()" aria-label="Toggle sidebar">
          <svg viewBox="0 0 24 24"><path d="M3 6h18v2H3zM3 11h18v2H3zM3 16h18v2H3z"/></svg>
        </button>

        <div class="biz-top-title">{{ title() }}</div>
        <div class="spacer"></div>

        <button class="biz-icon-btn theme-toggle" (click)="themeService.toggleTheme()" aria-label="Toggle Dark Mode" style="margin-right: 16px;">
          @if (themeService.isDarkMode()) {
            <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
          } @else {
            <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          }
        </button>

        <div class="biz-user-profile-wrap">
          <button class="biz-user-profile" (click)="toggleUserMenu()" [class.active]="userMenuOpen()">
            <div class="biz-avatar">{{ initial() }}</div>
          </button>

          @if (userMenuOpen()) {
            <div class="biz-user-menu">
              @if (auth.user(); as u) {
                <div class="biz-user-info">
                  <div class="biz-user-avatar">{{ initial() }}</div>
                  <div class="biz-user-details">
                    <span class="biz-user-email">{{ u.email }}</span>
                    <span class="biz-user-status">Role: {{ userRole() }}</span>
                  </div>
                </div>
              }

              <div class="biz-menu-divider"></div>
              <a class="biz-menu-item">Profile Settings</a>
              <button class="biz-menu-item" (click)="logout()" [disabled]="loading()">
                <span>{{ loading() ? 'Signing out...' : 'Sign out' }}</span>
              </button>
            </div>
          }
        </div>
      </header>

      <section class="biz-content">
        <router-outlet></router-outlet>
      </section>
    </main>
  </div>
} @else {
  <router-outlet></router-outlet>
}